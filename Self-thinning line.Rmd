---
title: "Self-thinning lines"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE}
remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
source("R/grow_tidy_expand_totals function.R")
source("R/base_params function.R")
source("R/run_mypatch_edit function.R")
source("R/grow_plot function.R")
```

```{r activate logger}
plant_log_console()
```

## 1. Grow stand: high resolution + recruitment decay
```{r}
allsteps <- grow_tidy_expand_totals(oderel=1e-4, odeabs=1e-4, scheps=0.0001, rec_decay=5)

allsteps %>%
  ggplot(aes(time, individuals)) +
  geom_line()

allsteps %>%
  ggplot(aes(time, area_stem_av)) +
  geom_line()

```


## 2. Self-thinnning Plot
Average size over time. Get average size by dividing total by the sum of individuals per unit area

```{r}
# self-thinning line, stem area, diameter (same line as stem area), or height?
allsteps  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

allsteps  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(height_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

# average stem area over time
allsteps %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_stem_av)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()
  
# first wave of individuals captured
allsteps %>% filter(height > 0, time> 0, time<150) %>%
  ggplot(aes(time, individuals, colour=height)) +
  geom_line() + 
  theme_classic()

```


## Trait comparisons
```{r}

# 1. thick (0.24 LMA) vs thin (0.07 LMA) leaves
lma_runs <- c(0.07, 0.24, 0.5) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")))

lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

lma_runs[[1]]  #pull out stuff

  
  lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

lma_values %>%
  mutate(area_leaf_av = area_leaf/individuals) %>%
  filter(time > 0.2, area_leaf_av > 1, area_leaf_av < 100) %>%
  ggplot(aes(area_leaf_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

#density over time both stands
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()


# 2. HMAT

hmat_values <- c(10, 25, 40) %>% map_dfr(~grow_tidy_expand_totals(traits=trait_matrix(.x, "hmat")), .id="run")
hmat_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()
   

# 3. leaf N - narea, B_lf1? How should I implement different values?

blf1_values <- c(0.2, 0.6, 1) %>% map_dfr(~grow_tidy_expand_totals(B_lf1 = .x), .id="run")
blf1_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

narea_values <- c(0.00187, 0.003) %>% map_dfr(~grow_tidy_expand_totals(narea = .x), .id="run")
narea_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```


### TASKS ###

# 1. plot total la and biomass over time - differences? how big?
# 2. turn into differences in self-thinning line, zoom in and out
# 3. vary multiple traits at once
# 4. before zoomed out log-log plot check differences are there or not
# 5. check stand:
#    a. with and without recruitment decay 
#    b. check LA and biomass over time, LA should be bigger than 0.5

1. plot total la and biomass over time - differences? how big?
```{r}

lma_runs <- c(0.07, 0.24, 0.5) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")))

lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

#LA over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

#total mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic()

#average mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_av, col = run)) +
  geom_line() +
  theme_classic()


narea_runs <- c(0.00187, 0.003, 0.005) %>% map(~grow_tidy_expand_totals(narea = .x))

narea_vals <- narea_runs %>% map_dfr(~.x$patch_total, .id = "run")

# LA over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

# total mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic()

# average mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_av, col = run)) +
  geom_line() +
  theme_classic()


# plot size distribution
lma_vals_expand <- lma_runs %>% map_dfr(~.x$patch_expand$species, .id = "run")
plot_size_distribution(lma_vals_expand)

narea_vals_expand <- narea_runs %>% map_dfr(~.x$patch_expand$species, .id = "run")
plot_size_distribution(narea_vals_expand)

```

2. turn into differences in self-thinning line, zoom in and out
```{r}
# self-thinning plots
lma_values %>%
filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

# zoom in/out
lma_values %>%
  mutate(area_leaf_av = area_leaf/individuals) %>%
filter(time > 0.2, area_leaf_av > 1, area_leaf_av < 100) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```

3. vary multiple traits at once
```{r}
#vary LMA + narea: high LMA, high N, med LMA med N, low LMA low N




```

4.before zoomed out log-log plot check differences are there or not
```{r}



```

5.check stand:
    a. with and without recruitment decay 
    b. check LA and biomass over time, LA should be bigger than 0.5
```{r}
# 1. with recruitment decay



# 2. without recruitment decay

lma_norec <- c(0.07, 0.24, 0.5) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), rec_decay = 0))
lma_vals_norec <- lma_norec %>% map_dfr(~.x$patch_total, .id = "run")

narea_norec <- c(0.00187, 0.003, 0.005) %>% map(~grow_tidy_expand_totals(narea = .x, , rec_decay = 0))
narea_vals_norec <- narea_norec %>% map_dfr(~.x$patch_total, .id = "run")



```



Traits again...

## STRATEGIES

## how to implement some strategies? Can I call on the hyperparameter function??

lma affects a few places in the model; see the source code, but only really for converting from leaf area to leaf mass (leaf mass being leaf area multiplied by leaf mass per unit leaf area). However, as a component of the leaf economic spectrum we imagine LMA as affecting a number of other components of the model.

We capture this through what we call a “hyper-parameterisation”; additional parameters and functions that mean that changing one parameter might affect a number of other lower-level parameters. Our default hyper-parameterisation is via the FF16_hyperpar function:
  FF16_hyperpar


  FF16_hyperpar(trait_matrix(0.1, "lma"), FF16_Strategy())

You will rarely need to call this function directly (see below) but note how setting of lma affects parameters k_l, a_p1 and r_l
These are: * k_l: Turnover rate for leaves * a_p1: Leaf photosynthesis per area * r_l: Leaf respiration per mass

This means that it is possible to implement different trade-offs between parameters relatively easily by modifying the hyper-parameterisation function in R, rather than having to modify the underlying physiological model in C++.

To make use of the hyper-parameterisation, the preferred way of setting parameters is through the utility functions strategy and strategy_list. These take a Parameters object:

  p <- FF16_Parameters()
  identical(p$hyperpar, FF16_hyperpar)
  class(p$strategy_default)

This (FF16_Strategy) is the Strategy object that all others will be built from by difference. Running:

  s <- strategy(trait_matrix(0.1, "lma"), p)
  
will create a strategy s where lma is set but also all the parameters that depend on lma.

  lma <- trait_matrix(seq(0.1, 0.5, length.out=5), "lma")

  FF16_hyperpar(trait_matrix(lma, "lma"), s)

```{r}
## LMA, B_LF1
lma07 <- grow_tidy_expand_totals(traits=trait_matrix(0.07, "lma"))
lma24 <- grow_tidy_expand_totals(traits=trait_matrix(0.24, "lma"))
blf1 <- grow_tidy_expand_totals(B_lf1 = 0.8273474)
blf2 <- grow_tidy_expand_totals(B_lf1 = 0.6)

ggplot() +
geom_line(data=lma07, aes(area_stem_av, individuals), color='green') + 
geom_line(data=lma24, aes(area_stem_av, individuals), color='red') +
geom_line(data=blf1, aes(area_stem_av, individuals), color='blue') +
geom_line(data=blf2, aes(area_stem_av, individuals), color='orange') +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()
```


```{r}



```


## Paired traits
```{r}



```


## Slope, Intercept, etc, values...
```{r}



```

