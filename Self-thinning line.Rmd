---
title: "Self-thinning lines"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE}
remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
source("R/grow_tidy_expand_totals function.R")
source("R/base_params function.R")
source("R/run_mypatch_edit function.R")
```

```{r activate logger}
plant_log_console()
```


```{r}
# default
allsteps1 <- grow_tidy_expand_totals(1e-4, 1e-4, 0.005, 0)

#higher resolution + recruitment decay
allsteps2 <- grow_tidy_expand_totals(oderel=1e-4, odeabs=1e-4, scheps=0.0001, rec_decay=5)

allsteps2 %>%
  ggplot(aes(time, individuals)) +
  geom_line()

allsteps2 %>%
  ggplot(aes(time, area_stem_av)) +
  geom_line()

allsteps1 %>%
  ggplot(aes(time, individuals)) +
  geom_line()

```


## Self-thinnning Plot
For this we need average size over time. Get average size by dividing total by the sum of individuals per unit area

## why such low heights and very low individuals?
## if colour by height, should they not keep getting taller (lighter line), but goes down? area_stem_av continues to increase though...

```{r}
allsteps2  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

  
allsteps2 %>% filter(step>80) %>% 
  ggplot(aes(area_stem_av, individuals)) +
  geom_line() +
  scale_y_log10() +
  scale_x_log10() + 
  theme_classic()


allsteps2 %>% filter(height > 0, time> 0, time<150) %>% 
  ggplot(aes(time, individuals, colour=height)) +
  geom_line() + 
  theme_classic()

```


##Vary LMA
```{r}
allsteps3 <- grow_tidy_expand_totals(scheps=0.0001, rec_decay=5, traits=trait_matrix(0.325, "lma")) %>% filter(time>0.2)

allsteps4 <- grow_tidy_expand_totals(scheps=0.0001, rec_decay=5, traits=trait_matrix(1.25, "lma")) %>% filter(time>0.2)

allsteps3  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

 allsteps4  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()
 
 #plot both

   ggplot() + geom_line(data = allsteps3, aes(area_stem_av, individuals)) +
   geom_line(data = allsteps4, aes(area_stem_av, individuals)) +
   scale_x_log10() +
   scale_y_log10() +
    theme_classic()
   
   ## add labels
```


##Vary HMAT
```{r}
allsteps5 <- grow_tidy_expand_totals(scheps=0.0001, rec_decay=5, traits=trait_matrix(20, "hmat")) %>% filter(time>0.2)

allsteps6 <- grow_tidy_expand_totals(scheps=0.0001, rec_decay=5, traits=trait_matrix(60, "hmat")) %>% filter(time>0.2)


## plot separately

allsteps5  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

allsteps6  %>% 
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=time)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```



