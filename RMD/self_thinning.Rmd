---
title: "Self-thinning progress"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning = FALSE, message=FALSE)
```


# Self-thinning -- theory

We are obtaining the self-thinning line from a size structured non-finite population growing through time. The model will be run under a series of species- and environment-specific scenarios

1. The "self-thinning line" is obtained when we plot N, the number of individuals of each time point, per unit area, against mean S, their mean size (e.g. via their height or stem diameter). Scaling both these axes by log10 produces a straight "thinning line". The total number of individuals across the size spectrum at each time point, and the total and then mean plant size is obtained through the following integrals:

$$ N_{T}= \int_{S_{0}}^{S_{MAX}}N(S)ds.....S_{T} = \int_{S_{0}}^{S_{MAX}} S.N(S)ds.....\overline{S} = \frac{S_{T}}{N_{T}} $$
i.e. the plot shows size-density (total N vs mean S) for points through time which forms the trajectory of the line. 

a. To get total N, we integrate N from initial to max size to get the total number of individuals of all size, integration done for each step through time. i.e. calculating the area under the curve from S_0 to S_MAX at time step 1, then the area under the curve from S_0 to S_MAX at time step 2, etc. 

b. Then integrating: S*N(S), each size value times the # of individuals at that size: from initial to max size, and mean size is just the average of the total quantity of size, so total height, divided by total number of individuals $N_{T}$.

c. We need the mean size $\overline S$ for our self-thinning line, which we can get by dividing the total size by total density at each step

2. We cannot simply use the "density" output from plant, which represents the cohorts or the expected/average individual trajectories of specific size/age classes with varying numbers over time. We must use the size/age data of all individual plants for the self-thinning dynamic to be observed. The integration must be weighted by the number of individuals in each size/age class. With cohorts we are just using a representative hypothetical individual without the details of how many individuals each may represent, the cohort-density with size. For example if we took 100 cohorts that each represent a different approximate age/size, each representing numbers from close to zero to numerous individuals, but we simply divided the total height by 100 rather than the number those 100 cohort "groups" represent, we essentially lose all the important individual density data.

3a. We want to improve our approximation by integrating with shorter time steps across the regions under the size-density curve we are interested in, accounting for the number of individuals and their mean height for each separate size class. In doing so, we are able to account for the continual influx of saplings which would otherwise skew our mean height and density data, and thus focus on the larger individuals that are growing into maturity. This can be done with the following integral and its approximate sum:

$$ \overline{H}=\int_0^\infty \frac{ Hn(H,t)}{N(t)}dt \simeq \frac{\sum H_{i}n(H_{i},t)(H_{i}-H_{i-1})}{\sum n(H_{i},t)(H_{i}-H_{i-1})} = \frac{\sum H_{i}}{K}$$
Not all our sub-intervals of integration will be equal in size/width, as the time steps in the initial stand phase are much shorter to account for the extremely dynamic nature of this period and to capture all of this detail. We cannot take K to be a sum of equal (Hi - (Hi-1)) segments. And the regular introduction of new individuals at different times means that we need to determine the density per height segment (Hi-(Hi-1)) per unit area, #/H/m^2

c. Trapazoidal Rule in R â†’ The Trapezoidal Rule is one of Closed Newton-Cotes formulas for approximating the definite integral of a function. We integrate by calculating and summing the areas of many consecutive trapezoids below our size-density curve, which gives a good approximation of the population dynamics in this case.

d. Additionally, we may need to select a cut-off point in the stand's age at which we stop incorporating new individuals into the model, as these new saplings likely pop up (when older larger plants die during the thinning process providing short periods of increased light and space?), but these saplings don't persist to compete with the main/mature stand. + minimum height to further reduce noise?

```{r}
remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
library(ggrepel)
source("R/grow_tidy_expand_totals function.R")
source("R/base_params function.R")
source("R/run_mypatch_edit function.R")
source("R/grow_plot function.R")
```

```{r activate logger}
plant_log_console()
```

Differences in self-thinning across species and environments - can traits and climate variables help us to understand these differences?

# Self-thinnning Plot
Average size over time. Get average size by dividing total of chosen size variable by the sum of individuals per unit area - we have mean stem area, mean stem diameter, mean height, mean mass above ground, and also mean leaf area (LA)

1. Grow a stand: higher resolution cohort spacing + recruitment decay = 0 (i.e. no decay)

Plots shows 1. the flow of individuals in the stand over time, 2. the leaf area over time, and 3. the self-thinning line that incorporates all individuals of all sizes and successional groups including multiple thinning periods. 

```{r}
no_rec <- grow_tidy_expand_totals(oderel=1e-4, odeabs=1e-4, scheps=0.0005, rec_decay=0)

no_rec$patch_total %>%
  ggplot(aes(time, individuals)) +
  geom_line()+
  ggtitle("Flow of Individuals over Time")

no_rec$patch_total %>%
  ggplot(aes(time, area_leaf)) +
  geom_line() +
  ggtitle("Leaf Area over Time")

no_rec$patch_total %>%
  filter(time>0.2) %>%
  ggplot(aes(area_stem_av, individuals)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() +
  ggtitle("Self-thinning Line")

```

# Exponential decay function 

This function was implemented to decrease the seed rain quickly and very early on to capture the trajectory of just the first wave of individuals in the stand. This is the function used to change the seed rain:

```{r}
seed_rain_decay <- function(seedrain = 100, decay = 0, time = seq(0, 10, by=0.01)){
  tibble(
    time = time,
    seeds = seedrain*exp(-decay*time)
  )
}

seed_rain_decay(100,5) %>%
  ggplot(aes(time, seeds)) +
  geom_line() 
```


# Traits -- LMA, HMAT, WD, leaf N, SM
(with recruitment decay implemented)

Trait comparison 1: 
LMA
-LMA thick vs thin leaves -- values: 0.07, 0.24, 0.5 [kg/m^2]
-Plot of LA over time and self-thinning lines with time stamps (year) on one plot and in separate plots
```{r}
lma_runs <- 
    c(0.07, 0.24, 0.5) %>% 
    map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")), .id="run")

lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("Leaf Area over Time")

find_closest <- function(x, at){
  
out <- rep("", length(x))  

for(a in at){
  dist <- abs(x-a)
  i <- which(dist == min(dist))
  out[i] <- a
  } 
out
}

lma_values %>%
  filter(time > 0.2) %>%
  mutate(
      my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))     
      ) %>%
  ggplot(aes(area_stem_av, individuals, col=run, label=my_label)) + 
  geom_line() + 
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()+ facet_wrap(~run) +
  ggtitle("Self-thinning lines: LMA/LL trade-off")
  

lma_values %>%
  filter(time > 0.2) %>%
  mutate(
      my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))     
      ) %>%
  ggplot(aes(area_stem_av, individuals, col=run, label=my_label)) + 
  geom_line() + 
  geom_text_repel(aes(label=my_label), nudge_x = 3) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() +
  ggtitle("LMA vs LL trade-off")


```

Trait comparison 2: 
Nitrogen per unit area

Values: 0.00187, 0.003, 0.005 [kg/m^2]
```{r}

narea_runs <- c(0.00187, 0.003, 0.005) %>% map(~grow_tidy_expand_totals(narea = .x), .id="run")

narea_vals <- narea_runs %>% map_dfr(~.x$patch_total, .id = "run")

narea_vals_expand <- narea_runs %>% map_dfr(~.x$patch_expand$species, .id = "run")

narea_vals %>%
  filter(time > 0.2) %>%
  mutate(
      my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))     
      ) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_y_log10() +
  scale_x_log10() +
  theme_classic() + facet_wrap(~run) +
  ggtitle("Nitrogen per unit area trade-off")

narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("LA over time")

narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  theme_classic() + facet_wrap(~run)

```

Trait comparison 3: 
HMAT

Values: 5, 10, 25 and 40 metres 
```{r}

hmat_runs <- c(5, 10, 25, 40) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "hmat")))

hmat_vals <-
  hmat_runs %>% map_dfr(~.x$patch_total, .id = "run")

hmat_vals %>%
  filter(time > 0.2) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))   
    ) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_y_log10() +
  scale_x_log10() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  theme_classic() + facet_wrap(~run) +
  ggtitle("HMAT trade-off")


hmat_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_above_ground, col = run)) +
  geom_line() +
  theme_classic() + facet_wrap(~run)

hmat_expand <- hmat_runs %>% map_dfr(~.x$patch_expand$species, .id = "run")
hmat_expand %>% filter(run == 1) %>% plot_size_distribution()
```

Trait comparison 4: 
Wood Density

Values:
```{r}

```


# Plotting LA and biomass over time
-> are there differences? how big? where?

1. LMA values: 0.07, 0.24, 0.5 [kg/m^2]
2. N per unit area values: 0.00187, 0.003, 0.005 [kg/m^2]
```{r}
# 1. LMA
lma_runs <- c(0.07, 0.24, 0.5) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")))
lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

#LA over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("Leaf Area over Time (LMA/LL vals)")

#total mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Total Biomass over Time (LMA/LL vals)")

#average mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Average Biomass over Time (LMA/LL vals)")

lma_values %>%
  filter(time > 0.2, time < 40) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Biomass from 0 - 40 years (LMA/LL vals)")

# 2. Leaf N
narea_runs <- c(0.00187, 0.003, 0.005) %>% set_names(.) %>% map(~grow_tidy_expand_totals(narea = .x))
narea_vals <- narea_runs %>% map_dfr(~.x$patch_total, .id="run")
narea_vals_expand <- narea_runs %>% map_dfr(~.x$patch_expand$species, .id="run")

# LA over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("Leaf Area over Time (N vals)")

# total mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Total Biomass over Time (N vals)")

# average mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Mean Biomass over Time (N vals)")

narea_vals %>%
  filter(time > 0.2, time < 40) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic() +
  ggtitle("Biomass from 0 - 40 years (N vals)")
```

# Differences in self-thinning line
- zoom in and out
```{r}
# self-thinning plots
lma_values %>%
mutate(
    my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))   
    ) %>%
filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() + facet_wrap(~run)

# zoomed in/out
lma_values %>%
  mutate(area_leaf_av = area_leaf/individuals) %>%
filter(time > 0.2, area_leaf_av > 1, area_leaf_av < 100) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()
```


# Vary two traits

LMA/narea all value combinations

- plot 1: self-thinning lines separate with time stamps
- plot 2: self-thinning lines together
- plot 3: LA over time
- plot 4: zoom into line
- plot 5: size distribution first run
- plot 6: total mass over time

- run, lma, narea
- 1   0.07  0.00187
- 2   0.07  0.003  
- 3   0.07  0.005  
- 4   0.24  0.00187
- 5   0.24  0.003  
- 6   0.24  0.005  
- 7   0.5   0.00187
- 8   0.5   0.003  
- 9   0.5   0.005  

```{r}
lma_narea <- expand_grid(lma=c(0.07, 0.24, 0.5), narea=c(0.00187, 0.003, 0.005)) %>% rowwise()
stands <- map2(lma_narea$lma, lma_narea$narea, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), narea = .y), .id="run")

stands_totals <- stands %>% map_dfr(~.x$patch_total, .id = "run")

stands_totals %>%
mutate(
    my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))   
    ) %>%
  filter(time>0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() + facet_wrap(~run) +
  ggtitle("Self-thinning lines (all permutations)")

stands_totals %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

stands_totals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("Leaf Area over Time")

stands_totals %>%
  filter(time > 0.2, area_stem_av > 1e-06, area_stem_av < 1e0) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() +
  ggtitle("Self-thinning lines (zoomed in)")

stands_expandsp <- stands %>% map_dfr(~.x$patch_expand$species, .id = "run")

p1 = stands_expandsp %>% filter(run == 1) %>% plot_size_distribution()
p1

stands_totals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col=run)) + 
  geom_line() +
  theme_classic() +
  ggtitle("Total Mass over Time")
```


# Varying 3 traits

LMA/narea/hmat

- LMA: 0.07, HMAT: 5, Narea: 0.00187,
- LMA: 0.125, HMAT: 10, Narea: 0.0025,
- LMA: 0.24, HMAT: 25, Narea: 0.0035,
- LMA: 0.5, HMAT: 40, Narea: 0.005

```{r}
tradeoffs <- list(c(0.07, 0.125, 0.24, 0.5), c(5, 10, 25, 40), c(0.00187, 0.0025, 0.0035, 0.005))
tradeoffs_runs <- pmap(tradeoffs, ~grow_tidy_expand_totals(traits=trait_matrix(..1, "lma"), trait_matrix(..2, "hmat"), narea = ..3))

tradeoffs_values <- tradeoffs_runs %>% map_dfr(~.x$patch_total, .id = "run")
tradeoffs_expand <- tradeoffs_runs %>% map_dfr(~.x$patch_expand$species, .id="run")

tradeoffs_values %>%
mutate(
    my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))   
    ) %>%
  filter(time > 0.2, area_stem_av >1e-07, area_stem_av < 1e-00) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() + facet_wrap(~run) +
  ggtitle("self-thinning lines")

tradeoffs_values %>%
  filter(time > 0.2, area_stem_av >1e-07, area_stem_av < 1e-00) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

tradeoffs_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()


tradeoffs_expand %>% filter(run == 3) %>% plot_size_distribution()

```


# Varying mortality rate
Rate of instantaneous mortality at rho_0 [/yr]

Varying the background mortality leads to different trajectory and stand outcomes
```{r}
mort_runs <- c(0.0, 0.1) %>% set_names(.) %>% map(~grow_tidy_expand_totals(B_dI1 = .x))

mort_values <-
  mort_runs %>% map_dfr(~.x$patch_total, .id = "run")
  
mort_values %>%
  ggplot(aes(time, area_leaf, col=run)) +
  geom_line() +
  ggtitle("Leaf Area over Time with different background mortality")

mort_values %>%
mutate(
    my_label = find_closest(round(time, 2), at = c(1.25, 2.5, 5, 10, 20, 40, 80))   
    ) %>%
  filter(time>0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) +
  geom_line() +
  geom_text_repel(aes(label=my_label), nudge_x = 2) +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic() +
  ggtitle("Self-thinning lines with different background mortality")

```


# Visualise tradeoffs
We can vary the scaling exponents in each trade-off to change the strength of the trade-off, how large the spectrum of values is

LMA vs k_l -- rate of leaf turnover x (LMA/mean LMA) ^ scaling exponent
```{r}
expand_grid(lma = seq(0.01, 0.4, by=0.001), B_kl2=c(0.5, 1.5, 2.2)) %>% rowwise() %>%
  mutate(
    ll=map2_dbl(lma, B_kl2, ~0.4565855*(.x/0.1978791)^-(.y))
  ) %>%
  filter(lma>0.02) %>%
  ggplot(aes(lma, ll, linetype=as.character(B_kl2))) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic(base_size = 20) +
  xlab("log LMA " ~ (kg/m^2)) +
  ylab("log Leaf Turnover " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")
```

Amax: max assimilation, Narea & photosynthesis and respiration rates -- [mol / d / m2]
```{r}
# Respiration and Amax
amax_resp <- expand_grid(narea = seq(0.00187, 0.0031, by=0.0001), B_lf5 = c(1, 2), B_lf4 = c(20000, 22000)) %>% rowwise() %>%
  mutate(
    amax=map2_dbl(narea, B_lf5, ~0.8273474*(.x/1.87e-3)^.y),
    resp=map2_dbl(narea, B_lf4, ~.y*(.x/0.08))
    )

p1 <- ggplot(amax_resp, aes(narea, amax, col=as.character(B_lf5))) + 
  geom_line() +
  theme_classic() +
  xlab("Narea [kg/m^2]") +
  ylab("Amax")

p2 <- ggplot(amax_resp, aes(narea, resp, col=as.character(B_lf4))) + 
  geom_line() +
  theme_classic() +
  xlab("Narea") +
  ylab("Respiration [per unit mass]")

p1 + p2

```


Wood density affecting DI mortality and wood turnover rate:
- 1. DI -- rate of inst. mortality x (rho/mean rho) ^ scaling exponent
- 2. k_s -- rate of sapwood turnover x (rho/mean rho) ^ scaling exponent
```{r}

DI_KS <- expand_grid(rho=seq(400, 800, by=10), B_dI2=c(0.5,3), B_ks2=c(0.5,3))%>% rowwise() %>% 
  mutate(
  DI = map2_dbl(rho, B_dI2, ~0.01*(.x/608)^-(.y)),
  KS = map2_dbl(rho, B_ks2, ~0.2*(.x/608)^-(.y)) 
  )

p0 <- ggplot(DI_KS, aes(rho, DI, col=as.character(B_dI2))) + 
  geom_line() +
  theme_classic() +
  xlab("wood density [kg/m^3]") +
  ylab("DI Mortality [/yr]")

p00 <- ggplot(DI_KS, aes(rho, KS, col=as.character(B_ks2))) + 
  geom_line() +
  theme_classic() +
  xlab("wood density [kg/m^3]") +
  ylab("wood turnover rate [/yr]")

p0 + p00
```
