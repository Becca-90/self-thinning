---
title: "Plots"
output: pdf_document
date: '2022-09-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval = FALSE}
#remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(magrittr)
install.packages('imager')
library(imager)
install.packages('ggpubr')
library(ggpubr)
library(purrr)
library(ggrepel)
library(scatterplot3d)
source("R/grow_tidy_expand_totals.R")
source("R/run_mypatch.R")
source("R/thinning_plot.R")
source("R/plot_stand.R")
source("R/find_closest_timestamps.R")
source("R/interpolate_to_stem_diameter.R")

#install.packages("ggforce")
library(ggforce)

install.packages("RColorBrewer")
library(RColorBrewer)
```

```{r activate logger}
plant_log_console()
```

# 1. Intro plot
typical stand + image panels + seed rain stls + empirical vs plant
```{r}
examplestand <- grow_tidy_expand_totals(a_dG2 = 30)
patch_totals <- examplestand$patch_total %>%
  mutate(
    study = "plant",
    replicate = 1
    ) %>%
  group_by(study, species)

typical_stand = patch_totals %>%
  ggplot(aes(diameter_stem_av, density)) +
  geom_abline(intercept = log(0.07), slope = -3/1.5, linetype = "dashed") +
  geom_line() +
  scale_x_log10(name = "stem diameter (m)") +
  scale_y_log10(name = "density " ~ (m^-2), limits = c(0.001, 200), labels = scales::comma) +
  theme_classic(base_size = 18) + 
  annotate(geom = "segment", x = 0.0011, y = 0.002, xend = 0.0011, yend = 16, size = 1, alpha=0.6, arrow = arrow(length = unit(2.5, "mm"), type = "closed")) +
  annotate(geom = "segment", x = 0.0015, y = 28, xend = 0.005, yend = 28, size = 1, alpha=0.6, arrow = arrow(length = unit(2.5, "mm"), type = "closed")) +
  annotate(geom = "segment", x = 0.006, y = 22, xend = 0.12, yend = 0.055, size = 1, alpha=0.6, arrow = arrow(length = unit(2.5, "mm"), type = "closed")) +
  geom_label(aes(x = 0.00135, y = 0.02, label = "1"), colour = "#5ec962") +
  geom_label(aes(x = 0.00145, y = 14, label = "2"), colour = "#5ec962") +
  geom_label(aes(x = 0.005, y = 14, label = "3"), colour = "#5ec962") + 
  geom_label(aes(x = 0.019, y = 0.9, label = "4"), colour = "#5ec962") +
  geom_label(aes(x = 0.15, y = 0.02, label = "5"), colour = "#5ec962") +
  theme(legend.position = "none")


birth_rate_runs <- c(0.1, 1, 10, 100, 1000) %>% set_names(.) %>% map(~grow_tidy_expand_totals(birth_rate = .x, hmat = 10, a_dG2 = 30, schedule_eps = 0.0005))

birth_rate_total <-
  birth_rate_runs %>% map_dfr(~.x$patch_total, .id = "trait_value")

birth_rates_stls = thinning_plot(birth_rate_total, xvar = "diameter_stem_av", xlims = c(5e-4, 2e-01), xlab = "stem diameter (m)", ylims = c(1e-2, 2e3))

birth_rates_stls = birth_rate_total %>%
  filter(time > 0.1) %>%
      mutate(
        my_label = find_closest(round(time, 2), at = c(10)),
        diameter_stem_av_cm = diameter_stem_av*100
      ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits = c(0.001, 2.0), labels = scales::comma, name = "stem diameter (m)") +
  scale_y_log10(limits = c(0.001, 1000), labels = scales::comma, name = "density " ~ (m^-2)) +
  theme_classic(base_size = 18) +
  theme(legend.position = "none") +
  scale_colour_viridis_d(option = "D")

ggsave(birth_rates_stls, filename = "../self-thinning/birth_rates_stls.pdf")

#panels_path <- "plots/self_thinning_panels_finalpng.png"
#self_thinning_panels <- readPNG(panels_path, native = TRUE, info = TRUE)

library(dplyr)
library(ggplot2) 
library(magick)
library(patchwork)

plt1 <- typical_stand
plt2 <- image_read("plots/new_panels_small.png") %>%
  image_ggplot()
plt3 <- birth_rates_stls
plt4 <- empirical_plot

intro_plot_top = ggarrange(plt2, plt1, labels = c("(a)", "(b)"))
intro_plot_base = ggarrange(plt4, plt3, labels = c("(c)", "(d)"))

intro_plot = intro_plot_top / intro_plot_base

ggsave(intro_plot, filename = "../self-thinning/plots/intro_plot.pdf", width = 12, height = 10)
```


```{r}

```


# 2. Varied initial density and HMATs
self-thinning plots
```{r}
# Varied seed mass
SM_vals = c(2.00e-07, 4.02e-06, 3.69e-05)   #0.00402 total SM?
SM_birth_rates =  c(20100, 1000, 108.9431)
SM_data = tibble(SM_vals, SM_birth_rates)
seed_mass_runs <- map2(SM_data$SM_vals, SM_data$SM_birth_rates, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "omega"), a_dG2 = 30, birth_rate = .y), .id = "trait_value") %>% set_names(c("low", "mid", "high"))

seed_mass_totals <-
  seed_mass_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(run = "Seed Mass")

seed_mass_totals$trait_value <- factor(seed_mass_totals$trait_value, levels=c("low", "mid", "high"))

SM_stl = thinning_plot(seed_mass_totals, xvar = "diameter_stem_av", xlims = c(0.00005, 1.0), xlab = "stem diameter (m)", ylims = c(0.01, 10000))

# Varied HMATs
hmat_runs <- c(1, 2, 5, 8, 12, 16, 20) %>% set_names(c("1m", "2m", "5m", "8m", "12m", "16m", "20m")) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "hmat"), a_dG2 = 30, a_f1 = 1))

hmat_total <-
  hmat_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(run = "HMAT")

hmat_stls = hmat_total %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(10)),
    diameter_stem_av_cm = diameter_stem_av*100
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  #geom_text(aes(label=my_label), hjust=-1, vjust=0) +
  scale_x_log10(limits = c(0.0015, 2.0), labels = scales::comma, name = "stem diameter (m)") +
  scale_y_log10(limits = c(0.0001, 1000), labels = scales::comma, name = "density " ~ (m^-2)) +
  theme_classic(base_size = 20) +
  theme(legend.position = "none") +
  ggtitle("Self-thinning under varied HMAT")


ggsave(hmat_stls, filename = "../self-thinning/hmat_stls.pdf", width = 10, height = 8)

hmats_seedmass_totals = bind_rows(seed_mass_totals, hmat_total)

cols_10 <- c("#fde725", "#bddf26", "#21918c", "#00CC788e", "#482475", "#355f8d", "#7ad151", "#2a788e", "#dfe318", "#44bf70")

hmats_birthrates_stls = hmats_seedmass_totals %>%
  filter(time>0.01) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(5)),
    diameter_stem_av_cm = diameter_stem_av*100
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits = c(0.0005, 2.0), labels = scales::comma, name = "stem diameter (m)") +
  scale_y_log10(breaks=c(0.01,1.0,100,1000), limits = c(0.0001, 5000), labels = scales::comma, name = "density " ~ (m^-2)) +
  theme_classic(base_size = 18) +
  theme(legend.position = "none") +
  facet_wrap(~run) +
  scale_color_manual(values = cols_10)
  
ggsave(hmats_birthrates_stls, filename = "../self-thinning/plots/hmats_birthrates_stls.pdf", height = 6, width = 12)
```

# Austraits data
```{r}
austraits <- read.csv("data/traits.csv", header = TRUE)
woodytraits <- read.csv("data/woodiness_2022.03.19.csv", header = TRUE)
sort(unique(austraits$trait_name))

austraits <- woodytraits %>% select(taxon_name, woodiness_recoded) %>% right_join(austraits) %>% mutate(ID = row_number())
```

```{r}
wood_density_vals <- austraits %>% 
  filter(trait_name == "wood_density", woodiness_recoded == "woody") %>% 
  mutate(ID = row_number())

leaf_n_vals <- austraits %>% 
  filter(trait_name == "leaf_N_per_area", woodiness_recoded == "woody") %>% 
  mutate(ID = row_number())

lma_vals <- austraits %>% 
  filter(trait_name == "specific_leaf_area", woodiness_recoded == "woody") %>%
  mutate(leaf_mass_area = 1/(as.numeric(value)))

seed_mass_vals <- austraits %>% 
  filter(trait_name == "seed_mass", woodiness_recoded == "woody") %>% 
  mutate(ID = row_number())

## 1/"specific_leaf_area" = LMA
```

```{r}
lma_trait_vals <- lma_vals$leaf_mass_area %>% as.numeric()
lma <- quantile(lma_trait_vals, probs = c(0.1, 0.5, 0.9)/1)

n_trait_vals <- leaf_n_vals$value %>% as.numeric()
n <- quantile(n_trait_vals, probs = c(0.1, 0.5, 0.9)/1)

wd_trait_vals <- wood_density_vals$value %>% as.numeric()
wd <- quantile(wd_trait_vals, probs = c(0.1, 0.5, 0.9)/1)

sm_trait_vals <- seed_mass_vals$value %>% as.numeric()
sm <- quantile(sm_trait_vals, probs = c(0.1, 0.5, 0.9)/1)

trait_values <- tibble(lma, n, wd, sm) %>% 
  mutate(n_kg=n/1000,
         wd_kg = wd*1000,
         sm_kg = sm*10^-6)
```

# 3. Visualise trade-offs
```{r}
lma_ll_tradeoff = expand_grid(lma = seq(0.01, 0.4, by=0.001), B_kl2=c(0.5, 1.5, 2.2)) %>% rowwise() %>%
  mutate(
    ll=map2_dbl(lma, B_kl2, ~0.4565855*(.x/0.1978791)^-(.y))
  ) %>%
  filter(lma>0.02) %>%
  ggplot(aes(lma, ll, linetype=as.character(B_kl2))) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic(base_size = 14) +
  xlab("LMA " ~ (kg/m^2)) +
  ylab("Leaf Turnover " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")

amax_resp <- expand_grid(narea = seq(0.001, 0.005, by=0.0001), B_lf5 = c(0.2, 1, 2), B_lf4 = 21000) %>%
  mutate(
    amax=map2_dbl(narea, B_lf5, ~0.8273474*(.x/1.87e-3)^.y),
    resp=map2_dbl(narea, B_lf4, ~.y*(.x/0.08))
    )

n_amax <- ggplot(amax_resp, aes(narea, amax, linetype=as.character(B_lf5))) + 
  geom_line() +
  theme_classic(base_size = 14) +
  xlab("Narea "  ~ (kg/m^2)) +
  ylab("Amax " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")

n_resp <- ggplot(amax_resp, aes(narea, resp, linetype=as.character(B_lf4))) + 
  geom_line() +
  theme_classic(base_size = 14) +
  xlab("Narea" ~(kg/m^2)) +
  ylab("Respiration " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")

dgdgdg
amax_resp_tradeoff <- ggplot(amax_resp, aes(resp, amax, linetype=as.character(B_lf5))) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic(base_size = 14) +
  xlab("Respiration " ~(yr^-1)) +
  ylab("Amax " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")

DI_KS <- expand_grid(rho=seq(400, 800, by=10), B_dI2=c(0, 2, 4), B_ks2=c(0, 2, 4))%>% rowwise() %>% 
  mutate(
  DI = map2_dbl(rho, B_dI2, ~0.01*(.x/608)^-(.y)),
  KS = map2_dbl(rho, B_ks2, ~0.2*(.x/608)^-(.y)),
  tradeoff_strength = recode(B_ks2, '0' = 'weak', '2' = 'mid', '4' = 'strong')
  )

wd_di_tradeoff <- ggplot(DI_KS, aes(rho, DI, linetype=as.character(B_dI2))) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic(base_size = 14) +
  xlab("Wood Density " ~ (kg/m^3)) +
  ylab("Mortality " ~(yr^-1)) + labs(colour="trade-off exponent") +
  theme(legend.position = "none")

DI_KS$tradeoff_strength <- factor(DI_KS$tradeoff_strength, levels=c("weak", "mid", "strong"))
wd_ks_tradeoff <- ggplot(DI_KS, aes(rho, KS, linetype=tradeoff_strength)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic(base_size = 14) +
  xlab("Wood Density " ~ (kg/m^3)) +
  ylab("Wood Turnover " ~(yr^-1)) +
  labs(linetype="Trade-off Strength")
```

# 4. Vary trade-off strength
self-thinning plots
```{r}
# LMA-LL: k_l <- B_kl1 * (lma/lma_0)^(-B_kl2)
lmas <- c(trait_values$lma[[1]], trait_values$lma[[2]], trait_values$lma[[3]])
b_kl2=c(0.5, 1.5, 2.2)
lma_bkl2 = expand_grid(lmas, b_kl2)

lma_bkl2_runs <- map2(lma_bkl2$lmas, lma_bkl2$b_kl2, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), B_kl2 = .y, a_dG2 = 30), .id = "trait_value")

lma_bkl2_totals <- lma_bkl2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = recode(trait_value, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "LMA & LL")

lma_bkl2_totals$trade_off_strength <- factor(lma_bkl2_totals$trade_off_strength, levels=c("weak", "mid", "strong"))
lma_bkl2_totals$trait_value <- factor(lma_bkl2_totals$trait_value, levels=c("low", "mid", "high"))

lma_bkl2_totals %>%
  mutate(max_height = `max_height$height_max`) %>%
  ggplot(aes(time, height_av, colour = trait_value)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~trade_off_strength)

# N-AMAX: Amax = B_lf1 * (narea/narea_0)^B_lf5, B_lf1 = 0.8273474, narea_0 = 0.00187, so varies in range 0.77629603291 (low N, small trade-off) to 4.43588711941 (high N, big trade-off)
n_vals <- c(trait_values$n_kg[[1]], trait_values$n_kg[[2]], trait_values$n_kg[[3]])
b_lf5=c(0.2, 1, 2)
n_blf5 = expand_grid(n_vals, b_lf5)

n_blf5_runs <- map2(n_blf5$n_vals, n_blf5$b_lf5, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "narea"), B_lf5 = .y, a_dG2 = 30), .id = "trait_value")
n_blf5_totals <- n_blf5_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = recode(trait_value, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high' ),
         trait = "N & Amax")

n_blf5_totals$trade_off_strength <- factor(n_blf5_totals$trade_off_strength, levels=c("weak", "mid", "strong"))
n_blf5_totals$trait_value <- factor(n_blf5_totals$trait_value, levels=c("low", "mid", "high"))

# WD-BKS2: k_s = B_ks1 * (rho/rho_0)^(-B_ks2), B_ks1 = 0.2, rho_0 = 608
wd_vals <- c(trait_values$wd_kg[[1]], trait_values$wd_kg[[2]], trait_values$wd_kg[[3]])
b_ks2=c(0, 2, 4)
wd_bks2 = expand_grid(wd_vals, b_ks2)

wd_bks2_runs <- map2(wd_bks2$wd_vals, wd_bks2$b_ks2, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "rho"), B_ks2 = .y, a_dG2 = 30), .id = "trait_value")
wd_bks2_totals <- wd_bks2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = recode(trait_value, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "WD & Wood Turnover")

wd_bks2_totals$trade_off_strength <- factor(wd_bks2_totals$trade_off_strength, levels=c("weak", "mid", "strong"))
wd_bks2_totals$trait_value <- factor(wd_bks2_totals$trait_value, levels=c("low", "mid", "high"))

# WD-BDI2: d_I <- B_dI1 * (rho/rho_0)^(-B_dI2) = 0.01 - 
wd_vals <- c(trait_values$wd_kg[[1]], trait_values$wd_kg[[2]], trait_values$wd_kg[[3]])
b_di2=c(0, 2, 4)
wd_bdi2 = expand_grid(wd_vals, b_di2)

wd_bdi2_runs <- map2(wd_bdi2$wd_vals, wd_bdi2$b_di2, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "rho"), B_dI1 = 0.01, B_dI2 = .y, a_dG2 = 30), .id = "trait_value")
wd_bdi2_totals <- wd_bdi2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = recode(trait_value, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "WD & Mortality")

wd_bdi2_totals$trade_off_strength <- factor(wd_bdi2_totals$trade_off_strength, levels=c("weak", "mid", "strong"))
wd_bdi2_totals$trait_value <- factor(wd_bdi2_totals$trait_value, levels=c("low", "mid", "high"))
```

Plot trade-off STLs with trade-off visuals above using facet wrap:
```{r}
all_tradeoff_totals <- tibble(bind_rows(lma_bkl2_totals, n_blf5_totals, wd_bks2_totals, wd_bdi2_totals))
all_tradeoff_totals$trait_value <- factor(all_tradeoff_totals$trait_value, levels=c("low", "mid", "high"))
cols = c("#90d743", "#21918c", "#3b528b")

all_tradeoff_stls = all_tradeoff_totals %>%
  filter(time > 0.1) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(10))
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_vline(xintercept = 0.1, linetype = "dashed", size = 0.2) +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits=c(0.001, 10.0), name = "stem diameter (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(limits=c(0.01, 100.0), name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
  scale_color_manual(values = cols)

tradeoffs_visuals_stls = (lma_ll_tradeoff | amax_resp_tradeoff | wd_di_tradeoff | wd_ks_tradeoff) / (all_tradeoff_stls) + plot_layout(heights = c(1, 4)) + plot_annotation(tag_levels = 'a')

ggsave(tradeoffs_visuals_stls, filename = "../self-thinning/tradeoffs_visuals_stls.pdf", width=16, height=10)
```

plot other STLs: density against leaf area, height, biomass
```{r}
all_tradeoff_stls_height = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, density > 1E-03) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(1, 10))
  ) %>%
  ggplot(aes(height_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "height (m)") +
  scale_y_log10(name = "density " ~ (m^-2)) +
  theme_classic(base_size = 18) +
  facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
  theme(legend.position = "none") +
  scale_color_manual(values = cols)

all_tradeoff_stls_biomass = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, density > 1E-03) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(1, 10))
  ) %>%
  ggplot(aes(mass_above_ground_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "AG biomass " ~(kg/m^3)) +
  scale_y_log10(name = "density " ~ (m^-2)) +
  theme_classic(base_size = 18) +
  facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
  theme(legend.position = "none") +
  scale_color_manual(values = cols)

all_tradeoff_stls_la = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, density > 1E-03) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(1, 10))
  ) %>%
  ggplot(aes(area_leaf_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "LA " ~(m^2)) +
  scale_y_log10(name = "density " ~ (m^-2)) +
  theme_classic(base_size = 18) +
  facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
  scale_color_manual(values = cols)

stls_other_vars = all_tradeoff_stls_height + all_tradeoff_stls_biomass + all_tradeoff_stls_la

ggsave(stls_other_vars, filename = "../self-thinning/stls_other_vars.pdf", width=24, height=6)
```

plot LA, AGB, height, stem size against time for all trade-offs
```{r}
la_time = all_tradeoff_totals %>%
  #filter(diameter_stem_av <= 0.1) %>%
  filter(area_leaf_av > 0.1) %>%
  mutate(my_label = find_closest(round(time, 2), at = c(5))) %>% 
  ggplot(aes(time, area_leaf_av, col = trait_value, label=my_label)) + 
    geom_line() +
    geom_text(aes(label=my_label), hjust=0, vjust=0) +
    scale_y_log10(name = "LA " ~(m^2), labels = scales::comma) +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

agb_time = all_tradeoff_totals %>%
  #filter(diameter_stem_av <= 0.1) %>%
  filter(mass_above_ground_av > 0.1) %>%
  mutate(my_label = find_closest(round(time, 2), at = c(5))) %>% 
  ggplot(aes(time, mass_above_ground_av, col = trait_value, label=my_label)) + 
    geom_line() +
    geom_text(aes(label=my_label), hjust=0, vjust=0) +
    scale_y_log10(name = "AG biomass " ~(kg/m^3), labels = scales::comma) +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

height_time = all_tradeoff_totals %>%
  #filter(diameter_stem_av <= 0.1) %>%
  filter(height_av > 1.0) %>%
  mutate(my_label = find_closest(round(time, 2), at = c(5))) %>%
  ggplot(aes(time, height_av, col = trait_value, label=my_label)) + 
    geom_line() +
    geom_text(aes(label=my_label), hjust=0, vjust=0) +
    scale_y_log10(name = "height (m)", labels = scales::comma) +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

stem_time = all_tradeoff_totals %>%
  #filter(diameter_stem_av <= 0.1) %>%
  filter(height_av > 1.0) %>%
  mutate(my_label = find_closest(round(time, 2), at = c(5))) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value, label=my_label)) + 
    geom_line() +
    geom_text(aes(label=my_label), hjust=0, vjust=0) +
    scale_y_log10(name = "height (m)", labels = scales::comma) +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

la_agb_height_stem_time = la_time + agb_time + height_time + stem_time
ggsave(la_agb_height_stem_time, filename = "../self-thinning/plots/la_agb_height_stem_time.pdf", width=16, height=12)
```

Plot density over time long-term and to 0.1 m stem diameter interpolations
```{r}
density_time = all_tradeoff_totals %>%
  #filter(diameter_stem_av <= 0.1, density > 1E-03, time > 0.1) %>%
  filter(time<40) %>%
  ggplot(aes(time, density, col = trait_value)) + 
    geom_line() +
    scale_y_log10() +
    scale_x_log10() +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

density_time_10cm = all_tradeoff_totals %>%
  filter(diameter_stem_av <= 0.1, density > 1E-03, time > 0.1) %>%
  ggplot(aes(time, density, col = trade_off_strength)) + 
    geom_line() +
    scale_y_log10(labels = scales::comma) +
    scale_x_log10() +
    theme_classic(base_size = 18) +
    facet_grid(trait_value~trait) +
    scale_color_manual(values = cols)

ggsave(density_time, filename = "../self-thinning/plots/density_time.pdf")
ggsave(density_time_10cm, filename = "../self-thinning/plots/density_time_10cm.pdf")
```

Compare amount of variation within equal trait-value stands due to trade-off strength
(comparing low, mid and high val stands under each trade-off strength)
```{r}
lma_b_kl2_runs <- map2(lma_bkl2$lmas, lma_bkl2$b_kl2, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), B_kl2 = .y, a_dG2 = 30), .id = "run")
lma_bkl2_totals <- lma_b_kl2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = trait_value,
         run = trait_value) %>%
  mutate(trade_off_strength = recode(trade_off_strength, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "LMA & LL")

n_blf5_runs <- map2(n_blf5$n_vals, n_blf5$b_lf5, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "narea"), B_lf5 = .y, a_dG2 = 30), .id = "run")
n_blf5_totals <- n_blf5_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = trait_value,
         run = trait_value) %>%
  mutate(trade_off_strength = recode(trade_off_strength, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "N & Amax")

wd_bks2_runs <- map2(wd_bks2$wd_vals, wd_bks2$b_ks2, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "rho"), B_ks2 = .y, a_dG2 = 30), .id = "run")
wd_bks2_totals <- wd_bks2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = trait_value,
         run = trait_value) %>%
  mutate(trade_off_strength = recode(trade_off_strength, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "WD & Wood Turnover")

wd_bdi2_runs <- map2(wd_bdi2$wd_vals, c(0,5,10), ~grow_tidy_expand_totals(traits=trait_matrix(.x, "rho"), B_dI1 = 0.01, B_dI2 = .y, a_dG2 = 30), .id = "run")
wd_bdi2_totals <- wd_bdi2_runs %>% 
  map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trade_off_strength = trait_value,
         run = trait_value) %>%
  mutate(trade_off_strength = recode(trade_off_strength, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(trait_value, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
         trait = "WD & Mortality")

wd_bdi2_totals %>%
  filter(diameter_stem_av < 0.1) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(2.5, 5))
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits=c(0.001, 10.0), name = "stem diameter (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(limits=c(0.01, 100.0), name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~trade_off_strength)

all_tradeoff_totals <- tibble(bind_rows(lma_bkl2_totals, n_blf5_totals, wd_bks2_totals, wd_bdi2_totals))
all_tradeoff_totals$trade_off_strength <- factor(all_tradeoff_totals$trade_off_strength, levels=c("weak", "mid", "strong"))
all_tradeoff_totals$trait_value <- factor(all_tradeoff_totals$trait_value, levels=c("low", "mid", "high"))

all_tradeoff_stls = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av < 0.1) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(2.5, 5))
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trade_off_strength, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits=c(0.001, 10.0), name = "stem diameter (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(limits=c(0.01, 100.0), name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(trait_value~trait) +
  scale_color_manual(values = cols)

ggsave(all_tradeoff_stls, filename="../self-thinning/plots/stls_tradeoff_effect_with_trait_value.pdf", width=16, height=14)
```

# 5. Interpolations  ***********************
interpolating with approx function

approx(x, y, xout, method="linear", n=50, yleft, yright, rule = 1, f = 0, ties = mean)
x, y: vectors of points to be interpolated, 
xout: an optional set of values specifying where interpolation is to take place e.g. stem diameter we want to interpolate
method: "linear" or "constant" 
```{r}
all_runs <- list(lma_bkl2_runs = lma_bkl2_runs, n_blf5_runs = n_blf5_runs, wd_bdi2_runs = wd_bdi2_runs, wd_bks2_runs = wd_bks2_runs)

f <- function(tmp){
  tibble(diameter_stem_av = 0.10, density = approx(tmp$patch_total$diameter_stem_av, tmp$patch_total$density, 0.10, "linear")$y)
}

interpolations <- all_runs %>% map_df(
    ~ map_df(.x, f, .id = "run"), .id = "group")



##### old version
interpolations10 <- list("", "", "", "")

for(i in c(1:4)) {
  interpolations10[[i]] <- map_df(c(1:9), ~interpolate_stem_diam(all_runs[[i]][[.x]]$patch_total$diameter_stem_av, all_runs[[i]][[.x]]$patch_total$density, xout=0.1), .id="run") %>% 
    mutate(trade_off_strength = recode(run, '1' = 'weak', '2' = 'mid', '3' = 'strong', '4' = 'weak', '5' = 'mid', '6' = 'strong', '7' = 'weak', '8' = 'mid', '9' = 'strong'),
         trait_value = recode(run, '1' = 'low', '2' = 'low', '3' = 'low', '4' = 'mid', '5' = 'mid', '6' = 'mid', '7' = 'high', '8' = 'high', '9' = 'high'),
           trait = i
           )
  i <- i+1
} 

tidy_interpolations10 <- rbind(interpolations10[[1]], interpolations10[[2]], interpolations10[[3]], interpolations10[[4]]) %>% 
  mutate(
    trait = recode(trait, '1' = 'LMA & LL', '2' = 'N & Amax', '3' = 'WD & Mortality', '4' = 'WD & Wood Turnover')
  ) %>%
  select(-run)
```

Merge interpolations with totals to plot STLs up to 0.1m
```{r}
all_tradeoff_totals <- tibble(bind_rows(lma_bkl2_totals, n_blf5_totals, wd_bks2_totals, wd_bdi2_totals)) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(5))
  ) %>%
  select(-'max_height$height_max')

tradeoff_totals_interpolations10 <- rbind(all_tradeoff_totals, tidy_interpolations10)

tradeoff_totals_interpolations10_plot <- 
  tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits=c(0.001, 10.0), name = "stem diameter (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(limits=c(0.01, 100.0), name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
  scale_color_manual(values = cols)


tradeoff_stls_visuals = (lma_ll_tradeoff | amax_resp_tradeoff | wd_di_tradeoff | wd_ks_tradeoff) / (tradeoff_totals_interpolations10_plot) + plot_layout(heights = c(1, 4)) + plot_annotation(tag_levels = 'a')

ggsave(tradeoff_stls_visuals, filename="../self-thinning/plots/tradeoff_stls_interpolations.pdf", width=18, height=14)
```

WD other STLs (LA, AGB, H, stem diameter)
```{r}
p1 = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, trait == "WD & Wood Turnover", diameter_stem_av > 0.001) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "stem diameter (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p2 = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, trait == "WD & Wood Turnover", diameter_stem_av > 0.001) %>%
  ggplot(aes(area_leaf_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "leaf area " ~ (m^2), labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p3 = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, trait == "WD & Wood Turnover", diameter_stem_av > 0.001) %>%
  ggplot(aes(mass_above_ground_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "AGB " ~ (kg/m^3), labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p4 = tradeoff_totals_interpolations10 %>%
  filter(diameter_stem_av <= 0.1, trait == "WD & Wood Turnover") %>%
  ggplot(aes(height_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(name = "height (m)", labels = scales::label_number(accuracy = 0.001)) +
  scale_y_log10(name = "density " ~ (m^-2), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

WD_other_STLs = p1 + p2 + p3 + p4
ggsave(WD_other_STLs, filename="../self-thinning/plots/WD_other_STLs.pdf", width=16, height=8)
```

WD variables over time (LA, AGB, height, stem diameter)
```{r}
p5 = tradeoff_totals_interpolations10 %>%
  filter(trait == "WD & Wood Turnover", diameter_stem_av > 0.001, area_leaf_av > 0.05) %>%
  ggplot(aes(time, area_leaf_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("leaf area " ~ (m^2)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p6 = tradeoff_totals_interpolations10 %>%
  filter(trait == "WD & Wood Turnover", diameter_stem_av > 0.001, mass_above_ground_av > 0.01) %>%
  ggplot(aes(time, mass_above_ground_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  #scale_y_log10(name = "AGB " ~ (kg/m^3), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p7 = tradeoff_totals_interpolations10 %>%
  filter(trait == "WD & Wood Turnover", diameter_stem_av > 0.001, height_av > 1.0) %>%
  ggplot(aes(time, height_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("height (m)") +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p8 = tradeoff_totals_interpolations10 %>%
  filter(time > 0.1, trait == "WD & Wood Turnover", diameter_stem_av > 0.001) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(trait~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

WD_vars_over_time = p5 + p6 + p7 + p8
ggsave(WD_vars_over_time, filename="../self-thinning/plots/WD_vars_over_time.pdf", width = 16, height = 12)
```

All stands diameter over time
First: until 0.1 m stem diameter
Second: over life of stand
```{r}
all_tradeoff_totals %>%
  filter(density > 1E-04, time > 1, trait == "WD & Wood Turnover", diameter_stem_av<=0.1) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value)) + 
    geom_line() +
    scale_y_log10() +
    theme_classic(base_size = 18) +
    facet_grid(factor(trade_off_strength, levels=c('weak','mid','strong'))~trait) +
    scale_color_manual(values = cols)

all_tradeoff_totals %>%
  filter(time > 0.1, trait == "WD & Wood Turnover", diameter_stem_av > 0.001) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value)) + 
    geom_line() +
    scale_y_log10(labels = scales::label_number(accuracy = 0.001)) +
    theme_classic(base_size = 18) +
    theme(plot.title = element_text(hjust=0.5)) +
    facet_grid(trait~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
    scale_color_manual(values = cols)
```

BAAD data
```{r}
baad_data <- read.csv("data/baad_data.csv", header = TRUE) %>%
  mutate(
    area_leaf = a.lf,
    height = h.t,
    mass_above_ground = m.so,
    mass_heartwood = m.sh,
    mass_sapwood = m.ss,
    time = age,
    diameter_stem = d.bh,
    node = 1,
    species = 1
  )

baad_data_dictionary <- read.csv("../self-thinning/data/baad_dictionary.csv", header = TRUE) %>% rbind()
baad_data_dictionary$label

variable_names <- baad_data_dictionary$label
```

Grow a "typical" stand:  
```{r}
examplestand <- grow_tidy_expand_totals(a_dG2 = 30)

example_stand_nodes <- examplestand$patch_expand$species %>% na.omit() %>%
  group_by(node) %>%
  mutate(age = time - min(time),
         studyName = "plant model")
```

Format dataframes:
```{r}
vars <- c("area_leaf", "mass_above_ground", "mass_sapwood", "mass_heartwood")
labels <- tibble(name = vars, label = c("leaf area", "above-ground mass", "sapwood mass", "heartwood mass"))

baad_data <- baad_data %>% select(time, age, node, species, height, diameter_stem, vars) %>%
  pivot_longer(vars) %>%
  left_join(labels)

example_stand_nodes <- example_stand_nodes %>% select(time, age, node, species, height, diameter_stem, vars) %>%
  pivot_longer(vars) %>%
  left_join(labels)
```

slightly different heights at times

# 7. Plot individual against BAAD data
```{r}
height_plots <- ggplot() +
  geom_point(data = baad_data, aes(height, value, group = node), col = "grey", size = 0.5) +
  geom_line(data = example_stand_nodes, aes(height, value, group = node), col = "#5ec962", size = 0.1) +
  facet_wrap(~label, scales = "free") +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  xlab("height (m)") +
  ylab("value") +
  theme_classic(base_size = 18)

stem_diameter_plots <- ggplot() +
  geom_point(data = baad_data, aes(diameter_stem, value, group = node), col = "grey", size = 0.5) +
  geom_line(data = example_stand_nodes, aes(diameter_stem, value, group = node), col = "#5ec962", size = 0.1) +
  facet_wrap(~label, scales = "free") +
  scale_x_log10(labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  xlab("stem diameter (m)") +
  ylab("value") +
  theme_classic(base_size = 18)

p1 = ggplot() +
  geom_point(data = baad_data, aes(age, height, group = node), col = "grey", size = 0.5) +
  geom_line(data = example_stand_nodes, aes(age, height, group = node), col = "#5ec962", size = 0.1) +
  scale_y_log10(labels = scales::comma) +
  xlim(0, 250) +
  ylab("height (m)") +
  theme_classic(base_size = 18)

p2 = ggplot() +
  geom_point(data = baad_data, aes(age, diameter_stem, group = node), col = "grey", size = 0.5) +
  geom_line(data = example_stand_nodes, aes(age, diameter_stem, group = node), col = "#5ec962", size = 0.1) +
  scale_y_log10(labels = scales::comma) +
  xlim(0, 250) +
  ylab("stem diameter (m)") +
  theme_classic(base_size = 18)

baad_plots = height_plots / stem_diameter_plots / (p1 | p2)

ggsave(baad_plots, filename = "../self-thinning/baad_plots.pdf", width = 10, height = 15)
```


8. Plot empirical data against plant output
First, create generic stand
```{r}
examplestand <- grow_tidy_expand_totals(a_dG2 = 30)
stand_totals <- examplestand$patch_total  %>%
  mutate(
    study = "plant",
    replicate = 1,
    #diameter_stem_av = (diameter_stem_av*100), #convert m to cm
    #density=density*10000                      #convert m^2 to ha
   ) %>%
  group_by(study, species, replicate)
```

Plot empirical data limiting self-thinning lines to min and max stem diameter values
```{r}
# remove data with missing diameter values
# log transform plant data to align with empirical data
empirical <- readxl::read_xlsx("data/empirical_data.xlsx", na=c("", "NA")) %>% 
  filter(
    !(study %in% c(
      "ge_et_al", # why?
      "forrester_et_al", # why?
      "pretzsch_mette") # why? 
      ),
    !(model %in% c(
      # removing models why?
      "OLS", "NB GLM", "POISSON GLM", "NLS", 
      # removing models why?
      "2B"))) %>%
  select(-min_n, -max_n) %>%
  # want to add data missing stem diameter values using slope and intercept
  mutate(min_dq = ifelse(is.na(min_dq), 5, min_dq),
         max_dq = ifelse(is.na(max_dq), 100, max_dq)) %>%
  rename("xmin" = "min_dq",
         "xmax" = "max_dq") %>%
  mutate(xmin = log(xmin),
         xmax = log(xmax))
  
  
# generate list of start and end points for each line and put into nice format
d <- empirical %>%
  mutate(id = row_number()) %>%
  mutate(across(starts_with("x"), ~ slope * . + intercept, .names = "y{stringr::str_sub(.col, 2, 4)}")) %>%
  pivot_longer(starts_with(c("x", "y"))) %>% 
  separate(name, into = c("var", "position"), sep = 1) %>% 
  pivot_wider(names_from = var)


# plot STLs including plant
empirical_plot <- d %>%
  mutate(
    diameter_stem_av = exp(x)/100, #align to `plant` units
    density = exp(y)/10000
  ) %>%
  filter(density > 0) %>%
  ggplot(aes(diameter_stem_av, density, group = paste(study, species, replicate), label = paste(study, species, replicate))) +
  geom_line(colour = "grey") +
  geom_line(data = stand_totals %>% 
  filter(density > 0.0001, diameter_stem_av > 0.01), colour = "#5ec962") +
  scale_x_log10() +
  scale_y_log10(label = scales::comma) +
  theme_classic() +
  xlab("stem diameter (m)") +
  ylab("density (ha)") +
  theme_classic(base_size = 18) +
  theme(legend.position = "none")

empirical_plot %>%
  plotly::ggplotly()

install.packages("plotly")
```

# Plot max height across time ***********************
```{r}
heights <- examplestand$patch_expand$species %>%
    select(-.data$node) %>% stats::na.omit() %>%
    filter(.data$step > 1) %>% 
    group_by(.data$step, .data$time, .data$patch_density, .data$species) %>% 
    summarise(
      density_integrated = -plant:::trapezium(.data$height, .data$density), 
      height_max = max(.data$height))

stand_totals_max_ht <- tibble(stand_totals, heights$height_max) %>%
  mutate(max_height = `heights$height_max`) %>%
  select(-`heights$height_max`)

ggplot(stand_totals_max_ht, aes(time, max_height)) +
  geom_line() +
  theme_classic() +
  ylab("max height (m)")
 
ggplot(stand_totals_max_ht, aes(time, height_av)) +
  geom_line() +
  theme_classic() +
  ylab("mean height (m)")

ggplot() +
  geom_line(data = stand_totals, aes(time, height_av, colour = "orange")) +
  geom_line(data = heights, aes(time, height_max, colour = "blue")) +
  theme_classic() +
  labs(x = "time", y = "height (m)") +
  scale_colour_discrete(name = "Height",
                        labels=c("max", "mean"))
```

Max Heights N stands
```{r}
heights1 <- n_blf5_runs[[9]]$patch_expand$species %>%
    select(-.data$node) %>% stats::na.omit() %>%
    filter(.data$step > 1) %>% 
    group_by(.data$step, .data$time, .data$patch_density, .data$species) %>% 
    summarise(
      density_integrated = -plant:::trapezium(.data$height, .data$density), 
      height_max = max(.data$height))

stand_totals_max_ht <- tibble(n_blf5_runs[[9]]$patch_total, heights$height_max) %>%
  mutate(max_height = `heights$height_max`) %>%
  select(-`heights$height_max`)

high_n_high_to = ggplot() +
  geom_line(data = n_blf5_runs[[9]]$patch_total, aes(time, height_av, colour = "orange")) +
  geom_line(data = heights, aes(time, height_max, colour = "blue")) +
  theme_classic() +
  labs(x = "time", y = "height (m)") +
  scale_colour_discrete(name = "Height",
                        labels=c("max", "mean"))



heights2 <- n_blf5_runs[[6]]$patch_expand$species %>%
    select(-.data$node) %>% stats::na.omit() %>%
    filter(.data$step > 1) %>% 
    group_by(.data$step, .data$time, .data$patch_density, .data$species) %>% 
    summarise(
      density_integrated = -plant:::trapezium(.data$height, .data$density), 
      height_max = max(.data$height))

high_n_mid_to = ggplot() +
  geom_line(data = n_blf5_runs[[6]]$patch_total, aes(time, height_av, colour = "orange")) +
  geom_line(data = heights2, aes(time, height_max, colour = "blue")) +
  theme_classic() +
  labs(x = "time", y = "height (m)") +
  scale_colour_discrete(name = "Height",
                        labels=c("max", "mean"))



heights3 <- n_blf5_runs[[3]]$patch_expand$species %>%
    select(-.data$node) %>% stats::na.omit() %>%
    filter(.data$step > 1) %>% 
    group_by(.data$step, .data$time, .data$patch_density, .data$species) %>% 
    summarise(
      density_integrated = -plant:::trapezium(.data$height, .data$density), 
      height_max = max(.data$height))

high_n_low_to = ggplot() +
  geom_line(data = n_blf5_runs[[3]]$patch_total, aes(time, height_av, colour = "orange")) +
  geom_line(data = heights3, aes(time, height_max, colour = "blue")) +
  theme_classic() +
  labs(x = "time", y = "height (m)") +
  scale_colour_discrete(name = "Height",
                        labels=c("max", "mean"))

high_n_high_to + high_n_mid_to + high_n_low_to
```

```{r}
#LMA & LL

p55 = tradeoff_totals_interpolations10 %>%
  filter(trait == "LMA & LL", diameter_stem_av > 0.001, area_leaf_av > 0.05) %>%
  ggplot(aes(time, area_leaf_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("leaf area " ~ (m^2)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p66 = tradeoff_totals_interpolations10 %>%
  filter(trait == "LMA & LL", diameter_stem_av > 0.001, mass_above_ground_av > 0.01) %>%
  ggplot(aes(time, mass_above_ground_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  #scale_y_log10(name = "AGB " ~ (kg/m^3), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p77 = tradeoff_totals_interpolations10 %>%
  filter(trait == "LMA & LL", diameter_stem_av > 0.001, height_av > 1.0) %>%
  ggplot(aes(time, height_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("height (m)") +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p88 = tradeoff_totals_interpolations10 %>%
  filter(time > 0.1, trait == "LMA & LL", diameter_stem_av > 0.001) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(trait~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

LA_vars_over_time = p55 + p66 + p77 + p88
ggsave(LA_vars_over_time, filename="../self-thinning/plots/LA_vars_over_time.pdf", width = 16, height = 12)

tradeoff_totals_interpolations10 %>%
  filter(time < 20, trait == "LMA & LL", diameter_stem_av > 0.001) %>%
  ggplot(aes(time, density, col = trait_value, label=my_label)) + 
  geom_line() +
  scale_y_log10() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(trait~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

#LMA & LL

p555 = tradeoff_totals_interpolations10 %>%
  filter(trait == "N & Amax", diameter_stem_av > 0.001, area_leaf_av > 0.05) %>%
  ggplot(aes(time, area_leaf_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("leaf area " ~ (m^2)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p666 = tradeoff_totals_interpolations10 %>%
  filter(trait == "N & Amax", diameter_stem_av > 0.001, mass_above_ground_av > 0.01) %>%
  ggplot(aes(time, mass_above_ground_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  #scale_y_log10(name = "AGB " ~ (kg/m^3), labels = scales::label_number(accuracy = 0.001)) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p777 = tradeoff_totals_interpolations10 %>%
  filter(trait == "N & Amax", diameter_stem_av > 0.001, height_av > 1.0) %>%
  ggplot(aes(time, height_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  ylab("height (m)") +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_wrap(~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

p888 = tradeoff_totals_interpolations10 %>%
  filter(time > 0.1, trait == "N & Amax", diameter_stem_av > 0.001) %>%
  ggplot(aes(time, diameter_stem_av, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  facet_grid(trait~factor(trade_off_strength, levels=c('weak','mid','strong'))) +
  scale_color_manual(values = cols)

N_vars_over_time = p555 + p666 + p777 + p888
ggsave(N_vars_over_time, filename="../self-thinning/plots/N_vars_over_time.pdf", width = 16, height = 12)
```
