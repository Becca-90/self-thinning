---
title: "Empirical 2"
output: html_document
date: '2022-09-23'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results='hide')
```

```{r, eval = FALSE}
remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
library(ggrepel)
library(scatterplot3d)
source("R/grow_tidy_expand_totals.R")
source("R/run_mypatch.R")
source("R/thinning_plot.R")
source("R/plot_stand.R")
source("R/find_closest_timestamps.R")
```

```{r activate logger}
plant_log_console()
```

# Here we compare model output with empirical datasets
First, grow a stand - traits and other preset values not altered
Initial seed rain is 200, a_l1 = 2.17 (height of plant with LA 1m^2), a_l2 = 0.5 (exponent of relationship between height and LA), lma = 0.1978791, rho = 608, hmat = 16.59587, B_lf1 = 0.8273474, B_lf2 = 0.5, recruitment decay = 5
```{r}
examplestand <- grow_tidy_expand_totals()
stand_totals <- examplestand$patch_total  
```

# Generate self-thinning lines from slope and intercept values obtained through statistical models of past papers

```{r}
empirical_studies <- read.csv("self_thinning_data.csv", header = TRUE)
```

```{r}
empirical_studies %>% group_by(study, species, replicate) %>% na.omit()

```

# Typical self thinning line using plant:
```{r}
examplestand <- grow_tidy_expand_totals(hmat = 15, a_dG2 = 30)

# correct for units -- m to cm, m^2 to ha
patch_totals <- examplestand$patch_total %>%
  mutate(
    diameter_stem_av = (diameter_stem_av*100),
    density=density*10000,
    study = "plant",
    replicate = 1
    ) %>%
  group_by(study, species)

  ggplot(patch_totals, aes(diameter_stem_av, density)) +
  geom_line() +
  scale_x_log10(name = "Mean stem diameter (cm)") +
  scale_y_log10(name = "Density (ha)") +
  theme_classic(base_size = 18)

# plot STL
typical_stand = examplestand$patch_total %>%
  ggplot(aes(diameter_stem_av, density)) +
  geom_line() +
  scale_x_log10(name = "mean stem diameter (m)") +
  scale_y_log10(name = "density " ~ (m^2), limits = c(0.001, 200), labels = scales::comma) +
  theme_classic(base_size = 18)

ggsave(typical_stand, filename = "../self-thinning/typical_stand.pdf", width = 6, height = 5)
```

# Plot self-thinning lines from compilation of datasets of major studies plotted with modelled STL using plant
```{r}
plant_and_empirical = ggplot(mapping = aes(diameter_stem_av, density, group = paste(study, species, replicate))) +
  geom_abline(intercept = 1, slope = -3/2, linetype = "dashed") +
  geom_line(data = prev_studies, col = "grey") +
  geom_line(data = patch_totals, size = 1, col = "black") + 
  scale_x_log10(limits = c(0.1, 500), labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  theme_classic(base_size = 18) +
  xlab("mean stem diameter (cm)") +
  ylab("density (ha)")


ggsave(plant_and_empirical, filename = "../self-thinning/plant_and_empirical.jpeg", width = 6, height = 5)
plot_size_distribution(examplestand$patch_expand$species)

# x and y limits from each study
```

```{r}
ggplot(mapping = aes(diameter_stem_av, density)) +
  geom_abline(intercept = 1, slope = -3/2, linetype = "dashed") +
  geom_line(data = prev_studies) +
  scale_x_log10(limits = c(0.1, 500), labels = scales::comma) +
  scale_y_log10(labels = scales::comma) +
  theme_classic(base_size = 18) +
  xlab("mean stem diameter (cm)") +
  ylab("density (ha)")

```

