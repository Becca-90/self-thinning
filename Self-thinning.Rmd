---
title: "Self-thinning"
output: html_document
---

## Self-thinning -- background info
Obtaining the Self-Thinning Line from a size structured non-finite population growing through time


1. The "self-thinning line" is obtained when we plot N, the number of individuals of each time point, per unit area (could also consider size structured density per unit time?), against mean S, their mean size (e.g. via their height or stem diameter). Scaling these axes by log10 produces a straight "thinning line".

$$ N_{T}= \int_{S_{0}}^{S_{MAX}}N(S)ds.....S_{T} = \int_{S_{0}}^{S_{MAX}} S.N(S)ds.....\overline{S} = \frac{S_{T}}{N_{T}} $$
i.e. the plot shows size-density (N-S) using the above integrals to calculate N and S across the size spectrum. 

a. To get the total N, we integrate N from initial to max size to get the total number of individuals, for all steps through time. I.e. calculating the area under the curve from S_0 to S_MAX at time step 1, then the area under the curve from S_0 to S_MAX at time step 2, etc → i.e. integrating: S*N(S), the size x the # of individuals at that size: from initial to max size, and mean size is just the total quantity of size e.g. combined heights / number at that height (N(T))

b. For total S, we integrate S, essentially calculating the number of individuals x their size from S0 to SMAX at each time step

c. We need the mean size $\overline S$ for our self-thinning line, which we can get by dividing the combined size by total density at each step

2. We cannot simply use the "density" output from plant, which represents the cohorts or the expected/average individual trajectories of specific size/age classes with varying numbers over time. We must use the size/age data of all individual plants for the self-thinning dynamic to be observed. The integration must be weighted by the number of individuals in each size/age class. With cohorts we are just using a representative hypothetical individual without the details of how many individuals each may represent, the cohort-density with size. For example if we took 100 cohorts that each represent a different approximate age/size, each representing numbers from close to zero to numerous individuals, but we simply divided the total height by 100 rather than the number those 100 cohort "groups" represent, we essentially lose all the important individual density data.


3a. We improve our approximation by integrating with shorter time steps across the regions under the size-density curve we are interested in, accounting for the number of individuals and their mean height for each separate size class. In doing so, we are able to account for the continual influx of saplings which would otherwise skew our mean height and density data, and thus focus on the larger individuals that are growing into maturity. This can be done with the following integral and its approximate sum:

$$ \overline{H}=\int_0^\infty \frac{ Hn(H,t)}{N(t)}dt \simeq \frac{\sum H_{i}n(H_{i},t)(H_{i}-H_{i-1})}{\sum n(H_{i},t)(H_{i}-H_{i-1})} = \frac{\sum H_{i}}{K}$$
b. However, we must recognise that not all our subintervals of integration will be equal in size/width, as the time steps in the initial stand phase are much shorter to account for the extremely dynamic nature of this period and to capture all of this detail. We cannot take K to be a sum of equal (Hi - (Hi-1)) segments. And the regular introduction of new individuals at different times means that we need to determine the density per height segment (Hi-(Hi-1)) per unit area, #/H/m^2


c. Trapazoidal Rule in R → The Trapezoidal Rule is one of Closed Newton-Cotes formulas for approximating the definite integral of a function. We integrate by calculating and summing the areas of many consecutive trapezoids below our size-density curve, which gives a good approximation of the population dynamics in this case.

d. Additionally, we may need to select a cut-off point in the stand's age at which we stop incorporating new individuals into the model, as these new saplings likely pop up (when older larger plants die during the thinning process providing short periods of increased light and space?), but these saplings don't persist to compete with the main/mature stand. + minimum height to further reduce noise?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval=FALSE}
#remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
source("R/grow_tidy_expand_totals function.R")
source("R/base_params function.R")
source("R/run_mypatch_edit function.R")
source("R/grow_plot function.R")
```

```{r activate logger}
plant_log_console()
```


## Differences in thinning across species and environments - can traits help us to understand these differences?

## Self-thinnning Plot
Average size over time. Get average size by dividing total of chosen size variable by the sum of individuals per unit area - we have mean stem area, mean stem diameter, mean height, mean mass above ground, and also mean LA

## Exponential decay function to capture first wave of individiuals

```{r}
##seed_rain*exp(-decay*time) time in years --> what does the exponential decay look like?
seed_rain_decay <- function(seedrain = 100, decay = 0, time = seq(0, 10, by=0.01)){
  tibble(
    time = time,
    seeds = seedrain*exp(-decay*time)
  )
}

seed_rain_decay(100,5) %>%
  ggplot(aes(time, seeds)) +
  geom_line() 

```

```{r}
no_rec <- grow_tidy_expand_totals(oderel=1e-4, odeabs=1e-4, scheps=0.0005, rec_decay=0)

no_rec$patch_total %>%
  ggplot(aes(time, individuals)) +
  geom_line()

no_rec$patch_total %>%
  ggplot(aes(time, area_leaf)) +
  geom_line()

no_rec$patch_total %>%
  filter(time>0.2) %>%
  ggplot(aes(area_stem_av, individuals)) +
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```


## Trait comparison: 1. LMA
```{r}

# 1. thick vs thin leaves
lma_runs <- 
    c(0.07, 0.24, 0.5) %>% set_names(.) %>% 
    map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")))

lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```

## Trait comparison: 2. narea
```{r}

narea_runs <- c(0.00187, 0.003, 0.005) %>% map(~grow_tidy_expand_totals(narea = .x), .id="run")
narea_vals <- narea_runs %>% map_dfr(~.x$patch_total, .id = "run")
narea_vals_expand <- narea_runs %>% map_dfr(~.x$patch_expand$species, .id = "run")

narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

narea_vals_expand %>% filter(run==2) %>% plot_size_distribution()

```

## Trait comparison: 3. HMAT
```{r}

hmat_runs <- c(5, 10, 25, 40) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "hmat")))
hmat_vals <-
  hmat_runs %>% map_dfr(~.x$patch_total, .id = "run")

hmat_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```


# 1. plot total LA and biomass over time - differences? how big?
```{r}

lma_runs <- c(0.07, 0.24, 0.5) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma")))
lma_values <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "run")

#LA over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

#total mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic()

#average mass over time
lma_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic()

lma_values %>%
  filter(time > 0.2, time < 15) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic()


narea_runs <- c(0.00187, 0.003, 0.005) %>% set_names(.) %>% map(~grow_tidy_expand_totals(narea = .x))
narea_vals <- narea_runs %>% map_dfr(~.x$patch_total, .id="run")
narea_vals_expand <- narea_runs %>% map_dfr(~.x$patch_expand$species, .id="run")

# LA over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

# total mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_total, col = run)) +
  geom_line() +
  theme_classic()

# average mass over time
narea_vals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, mass_above_ground_av, col = run)) +
  geom_line() +
  theme_classic()

```

# 2. turn into differences in self-thinning line, zoom in and out
```{r}
# self-thinning plots
lma_values %>%
filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

# zoom in/out
lma_values %>%
  mutate(area_leaf_av = area_leaf/individuals) %>%
filter(time > 0.2, area_leaf_av > 1, area_leaf_av < 100) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

```


# 3.a. vary two traits at once: LMA/narea
```{r}
lmas <- c(0.07, 0.24, 0.5)
nareas <- c(0.00187, 0.003, 0.005)   #x and y equal length, or one vector of length 1 will get repeated

lmas_nareas <- map2(lmas, nareas, ~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), narea = .y), .id = "run")

lmas_nareas_totals <- lmas_nareas %>% map_dfr(~.x$patch_total, .id = "run") 
## anonymous function takes .x from before pipe and feeds into $patch_total, .x is the lmas_hmats object, map_dfr needs a function so can't just do map_dfr(lmas_hmats$patch_total)
lmas_nareas_expandsp <- lmas_nareas %>% map_dfr(~.x$patch_expand$species, .id = "run")

lmas_nareas_totals %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()

lmas_nareas_totals %>%
  filter(time > 0.2) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

lmas_nareas_totals %>%
  filter(time > 0.2, area_stem_av > 1e-06, area_stem_av < 1e0) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

p1 = lmas_nareas_expandsp %>% filter(run == 1) %>% plot_size_distribution()

```


# 3.b. vary 3 traits: LMA/narea/hmat
```{r}
tradeoffs <- list(c(0.07, 0.125, 0.24, 0.5), c(5, 10, 25, 40), c(0.00187, 0.0025, 0.0035, 0.005))
tradeoffs_runs <- pmap(tradeoffs, ~grow_tidy_expand_totals(traits=trait_matrix(..1, "lma"), trait_matrix(..2, "hmat"), narea = ..3))

tradeoffs_values <- tradeoffs_runs %>% map_dfr(~.x$patch_total, .id = "run")
tradeoffs_expand <- tradeoffs_runs %>% map_dfr(~.x$patch_expand$species, .id="run")

tradeoffs_values %>%
  filter(time > 0.2, area_stem_av >1e-07, area_stem_av < 1e-00) %>%
  ggplot(aes(area_stem_av, individuals, col=run)) + 
  geom_line() +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()


tradeoffs_values %>%
  filter(time > 0.2) %>%
  ggplot(aes(time, area_leaf, col=run)) + 
  geom_line() +
  theme_classic()


tradeoffs_expand %>% filter(run == 3) %>% plot_size_distribution()

```


## Varying mortality rate -- Rate of instantaneous mortality at rho_0 [/yr]

```{r}
mort_runs <- c(0.0, 0.1) %>% set_names(.) %>% map(~grow_tidy_expand_totals(B_dI1 = .x))

mort_values <-
  mort_runs %>% map_dfr(~.x$patch_total, .id = "run")
  
mort_values %>%
  ggplot(aes(time, area_leaf, col=run)) +
  geom_line()


```


## Visualise tradeoffs
## LMA vs k_l -- rate of leaf turnover * (LMA/mean LMA) ^ scaling exponent
```{r}
expand_grid(lma = seq(0.07, 2.5, by=0.02), B_kl2=c(0.5,1.5)) %>% rowwise() %>%
  mutate(
    lma_ll=map2_dbl(lma, B_kl2, ~.x*(0.07/0.1978791)^.y)
  ) %>% 
  ggplot(aes(lma, lma_ll, col=as.character(B_kl2))) + 
  geom_line() +
  theme_classic() +
  xlab("LMA kg/m^2") +
  ylab("LMA - LL trade-off")


```


## Amax: max assimilation, Narea & photosynthesis and respiration rates  [mol / d / m2]
```{r}
# Respiration and Amax
amax_resp <- expand_grid(narea = seq(0.00187, 0.0031, by=0.0001), B_lf5 = c(1, 2), B_lf4 = c(19000, 21000, 23000)) %>%
  mutate(
    amax=map2_dbl(narea, B_lf5, ~0.8273474*(.x/1.87e-3)^.y),
    resp=map2_dbl(narea, B_lf4, ~.y*(.x/0.08))
    )

p1 <- ggplot(amax_resp, aes(narea, amax, col=as.character(B_lf5))) + 
  geom_line() +
  theme_classic() +
  xlab("Narea [kg/m^2]") +
  ylab("Amax")

p2 <- ggplot(amax_resp, aes(narea, resp, col=as.character(B_lf4))) + 
  geom_line() +
  theme_classic() +
  xlab("Narea") +
  ylab("Respiration [per unit mass]")

p1 + p2

```


## wood density affecting DI mortality and wood turnover rate 
# DI -- rate of inst. mortality * (rho/mean rho) ^ scaling exponent
# k_s -- rate of sapwood turnover * (rho/mean rho) ^ scaling exponent
```{r}

DI_KS <- expand_grid(rho=seq(400, 800, by=10), B_dI2=c(0.5,3), B_ks2=c(0.5,3))%>% rowwise() %>% 
  mutate(
  DI = map2_dbl(rho, B_dI2, ~0.01*(.x/608)^-(.y)),
  KS = map2_dbl(rho, B_ks2, ~0.2*(.x/608)^-(.y)) 
  )

p0 <- ggplot(DI_KS, aes(rho, DI, col=as.character(B_dI2))) + 
  geom_line() +
  theme_classic() +
  xlab("wood density [kg/m^3]") +
  ylab("WD - DI Mortality trade-off")

p00 <- ggplot(DI_KS, aes(rho, KS, col=as.character(B_ks2))) + 
  geom_line() +
  theme_classic() +
  xlab("wood density [kg/m^3]") +
  ylab("WD - wood turnover rate trade-off")

p0 + p00

```







extra stuff...
```{r}


# 1. Amax with mutate:
data_amax <- expand_grid(narea = seq(0.00187, 0.0031, by=0.0001), B_lf5 = c(1, 2)) %>% rowwise() %>%
  mutate(
    amax=amax_tradeoffs(narea = narea, B_lf5=B_lf5)
    )





k_l_tradeoffs <- function(lma_0 = 0.1978791,
                lma = 0.1978791,
                B_kl1=0.4565855,
                B_kl2=1.71){
  
B_kl1 * (lma / lma_0) ^ (-B_kl2)

}
expand_grid(lma = seq(0.07, 2.5, by=0.02), B_kl2=c(0.5,1.5)) %>% rowwise() %>%
  mutate(
    lma_ll=k_l_tradeoffs(lma=lma, B_kl2 = B_kl2)
  ) %>% 
  ggplot(aes(lma, lma_ll, col=as.character(B_kl2))) + 
  geom_line() +
  theme_classic() +
  xlab("LMA kg/m^2") +
  ylab("LMA - LL trade-off")

```