---
title: "Self-thinning plots"
output: html_document
date: '2022-08-10'
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results='hide')
```

```{r, eval = FALSE}
remotes::install_github("traitecoevo/plant", branch = "develop", force = TRUE)
```

```{r load libraries}
library(plant)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(purrr)
library(ggrepel)
library(scatterplot3d)
source("R/grow_tidy_expand_totals.R")
source("R/run_mypatch.R")
source("R/thinning_plot.R")
source("R/plot_stand.R")
source("R/find_closest_timestamps.R")
```

```{r activate logger}
plant_log_console()
```

# Grow stands with varied traits & plot self-thinning and LA - LMA, HMAT, NAREA, SM, WD
```{r}
# LMA
lma_runs <- 
    c(0.07, 0.24, 0.5) %>% set_names(.) %>%
    map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "lma"), hmat = 15, a_dG2 = 30), .id = "trait_value")
lma_totals <-
  lma_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trait_value = recode(trait_value, '0.07' = 'Low', '0.24' = 'Mid', '0.5' = 'High'),
         trait = "LMA")

thinning_plot(lma_totals, "diameter_stem_av", title = "Trait: LMA")
plot_stand(lma_totals, xvar = "time", yvar = "area_leaf", title="Total Leaf Area over time")

# NAREA
narea_runs <- c(0.00187, 0.005, 0.01) %>% set_names(.) %>%
  map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "narea"), hmat = 15, a_dG2 = 30), .id = "trait_value")
narea_total <- narea_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trait_value = recode(trait_value, '0.00187' = 'Low', '0.005' = 'Mid', '0.01' = 'High'),
         trait = "Leaf Nitrogen")

thinning_plot(narea_total, "diameter_stem_av", title = "Trait: leaf N")
plot_stand(narea_total, xvar = "time", yvar = "area_leaf", title="Total Leaf Area over time")

# HMAT
hmat_runs <- c(5, 15, 25) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "hmat"), B_dI1 = 0, a_dG2 = 30))
hmat_total <-
  hmat_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trait_value = recode(trait_value, '5' = 'Low', '15' = 'Mid', '25' = 'High'),
         trait = "HMAT")
thinning_plot(hmat_total, "diameter_stem_av", title = "Trait: HMAT")
plot_stand(hmat_total, xvar = "time", yvar = "area_leaf", title = "Total Leaf Area over time")

# WOOD DENSITY
wd_runs <- c(300, 600, 800) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "rho"), hmat = 15, a_dG2 = 30))
wd_total <-
  wd_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>%
  mutate(trait_value = recode(trait_value, '300' = 'Low', '600' = 'Mid', '800' = 'High'),
         trait = "Wood Density")

thinning_plot(wd_total, "diameter_stem_av", title = "Trait: Wood density")
plot_stand(wd_total, xvar = "time", yvar = "area_leaf", title = "Total Leaf Area over time")

# SEED MASS
seed_mass_runs <- c(1e-05, 0.001, 0.01) %>% set_names(.) %>% map(~grow_tidy_expand_totals(traits=trait_matrix(.x, "omega"), hmat = 15, a_dG2 = 30))
seed_mass_totals <-
  seed_mass_runs %>% map_dfr(~.x$patch_total, .id = "trait_value") %>% 
  mutate(trait_value = recode(trait_value, '1e-05' = 'Low', '0.001' = 'Mid', '0.01' = 'High'),
         trait = "Seed Mass")

thinning_plot(seed_mass_totals, "diameter_stem_av", title = "Trait: seed mass")
plot_stand(seed_mass_totals, xvar = "time", yvar = "area_leaf", title = "Total Leaf Area over time")
```

# with facet_wrap

```{r}
all_trait_totals <- tibble(bind_rows(lma_totals, narea_total, hmat_total, wd_total, seed_mass_totals))

all_trait_totals %>%
  filter(time > 0.1) %>%
  mutate(
    my_label = find_closest(round(time, 2), at = c(10)),
    diameter_stem_av_cm = diameter_stem_av*100, 
    density_m2=density*10000
  ) %>%
  ggplot(aes(diameter_stem_av, density, col = trait_value, label=my_label)) + 
  geom_line() +
  geom_text(aes(label=my_label), hjust=0, vjust=0) +
  scale_x_log10(limits=c(0.001, 1), name = "stem diameter (m)") +
  scale_y_log10(limits=c(0.01, 100), name = "density " ~ (m^2), labels = scales::comma) +
  theme_classic(base_size = 18) +
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle("Self-thinning -- varied trait values") + 
  facet_wrap(~trait, ncol = 2)

```



```{r}
labs(title = bquote("Hello" ~ r[xy] == .(cor2) ~ "and" ~ B^2))

parse(text = paste0('"Hello"', ' ~ r[xy] == ', cor2, '~ B^2'))

ggplot() + 
    labs(title = bquote("Eq 1:" ~ y[i] == alpha + beta * x[i] + epsilon[i] ~ "or" ~ .(cor2)))
```

